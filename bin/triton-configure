#!/bin/bash

# Couchbase-related environment variables
export MYIPPRIVATE=$(ip addr show eth0 | grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}')
export MYIPPUBLIC=$(ip addr show eth1 | grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}')
export MYMEMORY=$(free -m | grep -o "Mem:\s*[0-9]*" | grep -o "[0-9]*")
export MYCPUS=$(nproc)
export MYCPUS=$(($MYCPUS>12?$(($MYMEMORY/2048)):$MYCPUS))
export MYCPUS=$(($MYCPUS>1?$MYCPUS:1))
export COUCHBASE_NS_SERVER_VM_EXTRA_ARGS=$(printf '["+S", "%s"]' $MYCPUS)
export ERL_AFLAGS="+S $MYCPUS"
export GOMAXPROCS=$MYCPUS
export MYMEMORY=$(echo "$MYMEMORY*.80" | bc | grep -o "^[^\.]*")

installed ()
{
    echo '#'
    echo '# Couchbase is installed and configured'
    echo '#'
    echo "# Dashboard: http://$MYIPPUBLIC:8091"
    echo "# Internal IP: $MYIPPRIVATE"
    echo "# Bucket: $BUCKET"
    echo '# username=Administrator'
    echo '# password=password'
    echo '#'
}

if [ "$(couchbase-cli bucket-list -c 127.0.0.1:8091 -u Administrator -p password | grep ^$BUCKET)" == $BUCKET ]; then
    installed
    exit
fi

echo
echo '#'
echo '# Testing to see if Couchbase is running yet'
echo '#'

COUCHBASERESPONSIVE=0
while [ $COUCHBASERESPONSIVE != 1 ]; do
    echo -n '.'
    sleep .7

    # test the default u/p
    couchbase-cli server-info -c 127.0.0.1:8091 -u access -p password &> /dev/null
    if [ $? -eq 0 ]; then
        let COUCHBASERESPONSIVE=1
    fi
done

echo
echo '#'
echo '# Initializing node'
echo '#'

/opt/couchbase/bin/couchbase-cli node-init -c 127.0.0.1:8091 -u access -p password \
    --node-init-data-path=/opt/couchbase/var/lib/couchbase/data \
    --node-init-index-path=/opt/couchbase/var/lib/couchbase/data \
    --node-init-hostname=$MYIPPRIVATE

echo '#'
echo '# Looking for an existing cluster'
echo '#'

curl -v http://consul:8500/v1/catalog/service/couchbase | json -aH ServiceAddress

echo '#'
echo '# Joining cluster'
echo '#'

curl -i -u Administrator:password \
    http://192.168.129.188:8091/controller/addNode \
    -d "hostname=$(ip addr show eth0 | grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}')&user=admin&password=password"

echo '#'
echo '# Rebalancing cluster'
echo '#'

couchbase-cli rebalance -c 127.0.0.1:8091 -u Administrator -p password

echo '#'
echo '# Registering service instance'
echo '#'

curl http://165.225.190.200:8500/v1/agent/service/register -d "$(printf '{"ID":"couchbase-%s","Name":"couchbase","Address":"%s"}' $MYIPPRIVATE $MYIPPRIVATE)"

installed
